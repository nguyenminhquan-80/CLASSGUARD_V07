<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLASSGUARD - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --success: #4cc9f0;
            --warning: #f72585;
            --dark: #1a1a2e;
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand {
            font-weight: bold;
            color: var(--primary) !important;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .badge-admin {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }
        .badge-viewer {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-shield-alt me-2"></i>CLASSGUARD
            </a>
            <div class="d-flex align-items-center">
                <span class="me-3">
                    Xin chào, <strong>{{ username }}</strong>
                    <span class="badge {% if role == 'admin' %}badge-admin{% else %}badge-viewer{% endif %} ms-2">
                        {{ role|upper }}
                    </span>
                </span>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Điều khiển</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Quạt thông gió</label>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-success" onclick="controlDevice('fan', true)">
                                    <i class="fas fa-play"></i> BẬT
                                </button>
                                <button class="btn btn-danger" onclick="controlDevice('fan', false)">
                                    <i class="fas fa-stop"></i> TẮT
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Đèn lớp học</label>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-success" onclick="controlDevice('light', true)">
                                    <i class="fas fa-lightbulb"></i> BẬT
                                </button>
                                <button class="btn btn-danger" onclick="controlDevice('light', false)">
                                    <i class="fas fa-lightbulb"></i> TẮT
                                </button>
                            </div>
                        </div>
                        
                        {% if role == 'admin' %}
                        <div class="alert alert-info">
                            <small><i class="fas fa-info-circle"></i> Bạn có quyền Admin: được bật/tắt thiết bị</small>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <small><i class="fas fa-eye"></i> Bạn có quyền Xem: chỉ theo dõi, không điều khiển</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Evaluation -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Đánh giá tiết học</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="display-4 fw-bold text-primary" id="evaluationScore">--</div>
                        <p class="text-muted" id="evaluationRating">Đang tải...</p>
                        <div id="feedbackList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Main Dashboard -->
            <div class="col-md-9">
                <div class="row">
                    <!-- Sensor Cards -->
                    <div class="col-md-2 col-sm-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-thermometer-half fa-2x text-danger mb-3"></i>
                                <h6 class="text-muted">NHIỆT ĐỘ</h6>
                                <div class="sensor-value text-danger" id="tempValue">--</div>
                                <small class="text-muted">°C</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2 col-sm-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-tint fa-2x text-info mb-3"></i>
                                <h6 class="text-muted">ĐỘ ẨM</h6>
                                <div class="sensor-value text-info" id="humValue">--</div>
                                <small class="text-muted">%</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2 col-sm-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-wind fa-2x text-warning mb-3"></i>
                                <h6 class="text-muted">CHẤT LƯỢNG KK</h6>
                                <div class="sensor-value text-warning" id="airValue">--</div>
                                <small class="text-muted">PPM</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2 col-sm-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-sun fa-2x text-warning mb-3"></i>
                                <h6 class="text-muted">ÁNH SÁNG</h6>
                                <div class="sensor-value text-warning" id="lightValue">--</div>
                                <small class="text-muted">Lux</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2 col-sm-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-volume-up fa-2x text-success mb-3"></i>
                                <h6 class="text-muted">ÂM THANH</h6>
                                <div class="sensor-value text-success" id="soundValue">--</div>
                                <small class="text-muted">dB</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2 col-sm-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-clock fa-2x text-secondary mb-3"></i>
                                <h6 class="text-muted">CẬP NHẬT</h6>
                                <div class="sensor-value text-secondary" id="timeValue">--:--</div>
                                <small class="text-muted">giây trước</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Biểu đồ dữ liệu 24 giờ</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="sensorChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Table -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Dữ liệu gần đây</h5>
                                <a href="{{ url_for('export_csv') }}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-download"></i> Xuất CSV
                                </a>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Thời gian</th>
                                                <th>Nhiệt độ</th>
                                                <th>Độ ẩm</th>
                                                <th>Chất lượng KK</th>
                                                <th>Ánh sáng</th>
                                                <th>Âm thanh</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dataTable">
                                            <tr>
                                                <td colspan="6" class="text-center">Đang tải dữ liệu...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Biến toàn cục
        let sensorChart = null;
        let lastUpdate = new Date();
        
        // Cập nhật dữ liệu cảm biến mỗi 5 giây
        function updateSensorData() {
            fetch('/api/sensor-data')
                .then(response => response.json())
                .then(data => {
                    if (data.temperature !== undefined) {
                        // Cập nhật giá trị
                        document.getElementById('tempValue').textContent = data.temperature.toFixed(1);
                        document.getElementById('humValue').textContent = data.humidity.toFixed(1);
                        document.getElementById('airValue').textContent = data.air_quality.toFixed(0);
                        document.getElementById('lightValue').textContent = data.light.toFixed(0);
                        document.getElementById('soundValue').textContent = data.sound.toFixed(1);
                        
                        // Cập nhật thời gian
                        const now = new Date();
                        const diff = Math.floor((now - lastUpdate) / 1000);
                        document.getElementById('timeValue').textContent = `${diff}s`;
                        lastUpdate = now;
                        
                        // Lấy đánh giá
                        fetch('/api/historical-data?hours=1')
                            .then(r => r.json())
                            .then(historical => {
                                // Tính đánh giá đơn giản
                                evaluateData(data);
                            });
                    }
                })
                .catch(error => console.error('Lỗi:', error));
        }
        
        // Điều khiển thiết bị
        function controlDevice(device, state) {
            {% if role != 'admin' %}
                alert('Bạn không có quyền điều khiển thiết bị!');
                return;
            {% endif %}
            
            fetch('/api/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({device: device, state: state})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`Đã ${state ? 'BẬT' : 'TẮT'} ${device.toUpperCase()} thành công!`);
                } else {
                    alert('Có lỗi xảy ra!');
                }
            });
        }
        
        // Đánh giá dữ liệu
        function evaluateData(data) {
            let score = 0;
            let feedback = [];
            
            // Logic đánh giá đơn giản
            if (data.temperature >= 23 && data.temperature <= 27) score += 20;
            if (data.humidity >= 40 && data.humidity <= 70) score += 20;
            if (data.air_quality < 200) score += 20;
            if (data.light >= 300 && data.light <= 500) score += 20;
            if (data.sound < 60) score += 20;
            
            let rating = score >= 80 ? 'Xuất sắc' :
                        score >= 60 ? 'Tốt' :
                        score >= 40 ? 'Trung bình' : 'Cần cải thiện';
            
            document.getElementById('evaluationScore').textContent = score;
            document.getElementById('evaluationRating').textContent = rating;
        }
        
        // Khởi tạo biểu đồ
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Nhiệt độ (°C)',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Độ ẩm (%)',
                            data: [],
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
            
            // Cập nhật biểu đồ
            updateChart();
        }
        
        // Cập nhật biểu đồ
        function updateChart() {
            fetch('/api/historical-data?hours=24')
                .then(response => response.json())
                .then(data => {
                    if (sensorChart && data.timestamps.length > 0) {
                        sensorChart.data.labels = data.timestamps.map(t => 
                            new Date(t).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})
                        );
                        sensorChart.data.datasets[0].data = data.temperature;
                        sensorChart.data.datasets[1].data = data.humidity;
                        sensorChart.update();
                    }
                });
        }
        
        // Khởi chạy
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            updateSensorData();
            // Cập nhật mỗi 5 giây
            setInterval(updateSensorData, 5000);
            // Cập nhật biểu đồ mỗi 30 giây
            setInterval(updateChart, 30000);
        });
    </script>
</body>
</html>